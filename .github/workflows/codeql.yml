name: CodeQL

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
  schedule:
    - cron: '23 6 * * 0'

jobs:
  codeql:
    name: CodeQL - C/C++
    runs-on: ubuntu-22.04
    permissions:
      security-events: write
      packages: read
      actions: read
      contents: read

    steps:
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          sudo docker image prune --all --force
          df -h

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y -o Acquire::Retries=50 \
               mtools syslinux isolinux \
               libc6-dev-i386 \
               build-essential

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: c-cpp
          build-mode: manual

      - name: Build iPXE (representative targets)
        run: |
          # Build key targets that exercise most code paths
          # Avoid 'everything' - it exhausts disk space
          make -C src -j$(nproc) \
            bin/ipxe.iso \
            bin/ipxe.usb \
            bin/ipxe.lkrn \
            bin/undionly.kpxe \
            bin/ipxe.pxe \
            bin-x86_64-efi/ipxe.efi \
            bin-x86_64-pcbios/ipxe.hd

      - name: Perform CodeQL analysis
        uses: github/codeql-action/analyze@v3
  codeql-efi:
    name: CodeQL - EFI
    runs-on: ubuntu-22.04
    permissions:
      security-events: write
      packages: read
      actions: read
      contents: read

    steps:
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo docker image prune --all --force

      - name: Checkout
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: c-cpp
          build-mode: manual

      - name: Build EFI targets
        run: |
          make -C src -j$(nproc) bin-x86_64-efi/ipxe.efi bin-i386-efi/ipxe.efi

      - name: Perform CodeQL analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:c-cpp-efi"
        with:
          category: "/language:c-cpp"
